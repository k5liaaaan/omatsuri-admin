// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  organizerName String? // お祭り主催団体名
  isAdmin   Boolean  @default(false) // 管理者フラグ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  festivals Festival[] // お祭りとの関連
  pendingEmailChanges PendingEmailChange[]

  @@map("users")
}

model PendingUserRegistration {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  token      String   @unique
  expiresAt  DateTime
  completed  Boolean  @default(false)
  completedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("pending_user_registrations")
}

model PendingEmailChange {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  newEmail   String
  token      String   @unique
  expiresAt  DateTime
  completed  Boolean  @default(false)
  completedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("pending_email_changes")
}

model Prefecture {
  id          Int           @id @default(autoincrement())
  code        String        @unique // 都道府県コード（例：12）
  name        String        @unique // 都道府県名（例：千葉県）
  municipalities Municipality[]
  municipalityRequests MunicipalityRequest[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("prefectures")
}

model Municipality {
  id           Int        @id @default(autoincrement())
  code         String     @unique // 市区町村コード（例：12101）
  name         String     // 市区町村名（例：千葉市中央区）
  prefectureId Int
  prefecture   Prefecture @relation(fields: [prefectureId], references: [id])
  festivals    Festival[] // お祭りとの関連
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("municipalities")
}

model Festival {
  id              Int          @id @default(autoincrement())
  name            String       // お祭り名
  municipalityId  Int          // 市区町村ID
  municipality    Municipality @relation(fields: [municipalityId], references: [id])
  address         String       // 詳細住所
  content         String       // お祭りの内容
  foodStalls      String?      // 出店情報（オプション）
  sponsors        String?      // 協賛（スポンサー）情報（オプション）
  organizerId     Int          // 主催団体ID（ユーザーID）
  organizer       User         @relation(fields: [organizerId], references: [id])
  isVisible       Boolean      @default(true) // 表示フラグ（true: 表示, false: 非表示）
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  schedules       FestivalSchedule[] // 開催日程との関連

  @@map("festivals")
}

model FestivalSchedule {
  id          Int      @id @default(autoincrement())
  festivalId  Int      // お祭りID
  festival    Festival @relation(fields: [festivalId], references: [id], onDelete: Cascade)
  date        String   // 開催日（YYYY-MM-DD形式）
  startTime   String   // 開始時間（HH:MM形式）
  endTime     String   // 終了時間（HH:MM形式）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("festival_schedules")
}

model LoginAttempt {
  id        Int      @id @default(autoincrement())
  username  String   // ユーザー名
  success   Boolean  // ログイン成功/失敗
  ipAddress String?  // IPアドレス（オプション）
  createdAt DateTime @default(now())

  @@map("login_attempts")
}

model MunicipalityRequest {
  id           Int      @id @default(autoincrement())
  prefectureId Int      // 都道府県ID
  prefecture   Prefecture @relation(fields: [prefectureId], references: [id])
  name         String   // リクエストされた市区町村名
  status       String   @default("pending") // pending, approved, rejected
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("municipality_requests")
}
